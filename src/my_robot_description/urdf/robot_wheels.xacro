<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">



  <!-- ============================================ -->
  <!-- 바퀴 매크로 정의 -->
  <!-- ============================================ -->  

  <xacro:macro name="wheel" params="prefix y_reflect">
    <!--
      params:
        prefix: "left" 또는 "right" (이름 접두사)
        y_reflect: +1 (왼쪽) 또는 -1 (오른쪽) (Y방향 반전)
        
        이 매크로를 호출하면 Joint + Link가 자동 생성
    -->
    
    <joint name="${prefix}_wheel_joint" type="continuous">
      <!--
        ${prefix}_wheel_joint
          → "left_wheel_joint" 또는 "right_wheel_joint"
          → 문자열 조합이 가능
      -->
      <parent link="base_link"/>
      <child link="${prefix}_wheel"/>
      <origin xyz="${wheel_x_offset} ${y_reflect * wheel_separation / 2} ${wheel_z_offset}" rpy="0.0 0.0 0.0"/>
      <!--
        Y 위치 계산:
          left:  +1 * 0.345/2 = +0.172.5
          right: -1 * 0.345/2 = -0.172.5
      -->
      <axis xyz="0 1 0"/>
      
      
      <!-- ⭐ 감쇠 추가! -->
      <dynamics damping="0.1" friction="0.05"/>
      <!--
        damping = 0.1: 속도 1 rad/s에서 0.1 N·m의 저항 토크 (바퀴가 돌 때 저항을 줌. 속도가 빠를수록 저항 토크가 커짐.)
          바퀴가 330 RPM(=34.6 rad/s)일 때: 저항 토크 = 0.1 × 34.6 = 3.46 N·m
          → 모터 토크(1.5 N·m)보다 큼?
          → diff_drive 플러그인은 max_wheel_torque를 적용하므로 
            모터가 이 저항을 이길 수 있도록 max_wheel_torque ≥ 필요 토크 + 감쇠 토크!
            
          ⚠️ max_wheel_torque가 너무 작으면 damping 때문에 바퀴가 안 돌 수 있음
             
        friction = 0.05: 정지 시 0.05 N·m의 고정 마찰 (바퀴가 멈춰 있을 때 "정지 마찰"을 줌.)
          → 경사에서 굴러내려가지 않도록!
          → 미세한 값이므로 동작에 큰 영향 없음
      -->

      <limit effort="5.0" velocity="40.0"/>
      <!--
        effort: 최대 토크 제한 (N·m)
          5.0 N·m = JGB37-520 스톨 토크의 ~1/3 → 모터가 발휘할 수 있는 연속 토크
          
        velocity: 최대 각속도 제한 (rad/s)
          40.0 rad/s ≈ 382 RPM → 330 RPM(34.6 rad/s) + 여유
          
        limit 태그의 역할: Gazebo가 이 한계를 넘지 않도록 제한 → 실제 모터의 물리적 한계를 시뮬에 반영
      -->
    </joint>
    

    <link name="${prefix}_wheel">
      <visual>
        <origin xyz="0.0 0.0 0.0" rpy="${pi/2} 0.0 0.0"/>
        <geometry>
          <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
        </geometry>
        <material name="black">
          <color rgba="0.1 0.1 0.1 1.0"/>
        </material>
      </visual>
      
      <collision>
        <origin xyz="0.0 0.0 0.0" rpy="${pi/2} 0.0 0.0"/>
        <geometry>
          <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
        </geometry>
      </collision>
      
      <xacro:cylinder_inertia m="${wheel_mass}" r="${wheel_radius}" h="${wheel_width}"/>
      <!-- ⭐ 관성 모멘트 매크로 호출 → robot_properties.xacro에서 정의한 매크로 -->
    </link>
    

    <!-- Gazebo 마찰 설정 -->
    <gazebo reference="${prefix}_wheel">
      <material>Gazebo/Black</material>
      <mu1>1.0</mu1>
      <mu2>1.0</mu2>
      <kp>1000000.0</kp>
      <kd>10.0</kd>
    </gazebo>
    
  </xacro:macro>


  <!-- 매크로 호출 — 바퀴 2개 생성! -->

  <xacro:wheel prefix="left" y_reflect="1"/>
  <!--
    이 한 줄로 생성되는 것:
      ✅ left_wheel_joint (continuous, Y=+0.172.5)
      ✅ left_wheel (link with visual/collision/inertial)
      ✅ Gazebo 마찰 설정
  -->
  
  <xacro:wheel prefix="right" y_reflect="-1"/>
  <!--
    이 한 줄로 생성되는 것:
      ✅ right_wheel_joint (continuous, Y=-0.172.5)
      ✅ right_wheel (link with visual/collision/inertial)
      ✅ Gazebo 마찰 설정
  -->




  <!-- ============================================ -->
  <!-- 캐스터 매크로 정의 -->
  <!-- ============================================ -->
  
  <!--  
    설계 의도:
      1. 물리적 지지력 제공 (로봇이 기울어지지 않음)
      2. 극히 낮은 마찰 → diff_drive에 간섭 안 함
      3. 구체라서 어느 방향으로든 자유롭게 굴러감
      
    실제 볼 캐스터:
      → 하우징 안에서 볼이 자유 회전
      → 시뮬에서는 저마찰 구체로 동일한 효과
  -->
  
  <xacro:macro name="caster_wheel" params="prefix y_reflect">
    
    <joint name="${prefix}_caster_joint" type="fixed">
      <!--
        type="fixed":
          캐스터를 base_link에 고정!
          
        왜 continuous가 아닌 fixed?
          → 실제 볼 캐스터는 회전하지만 시뮬에서는 저마찰 구체가 지면 위에서 미끄러짐
          → Joint을 추가하면 불필요한 복잡성만 늘어남
          → fixed + 저마찰 = 업계 표준 패턴
      -->
      <parent link="base_link"/>
      <child link="${prefix}_caster_link"/>
      <origin xyz="${caster_x_offset} ${y_reflect * caster_y_separation / 2} ${caster_z_offset}" rpy="0.0 0.0 0.0"/>
      <!--
        left:  Y = +1 × 0.280/2 = +0.140
        right: Y = -1 × 0.280/2 = -0.140
        Z = -0.045 (지면 바로 위)
      -->
    </joint>
    

    <link name="${prefix}_caster_link">  
      <visual>
        <geometry>
          <sphere radius="${caster_radius}"/>
        </geometry>
        <material name="dark_grey">
          <color rgba="0.3 0.3 0.3 1.0"/>
        </material>
      </visual>
      
      <collision>
        <geometry>
          <sphere radius="${caster_radius}"/>
        </geometry>
      </collision>
      
      <xacro:sphere_inertia m="${caster_mass}" r="${caster_radius}"/>
    </link>
    

    <!-- Gazebo 마찰 설정 -->
    <gazebo reference="${prefix}_caster_link">
      <material>Gazebo/DarkGrey</material>
      <mu1>0.001</mu1>
      <mu2>0.001</mu2>
      <!--
        ⭐ 핵심: 마찰이 거의 0!
       
        mu = 0.001:
          구동 바퀴: mu = 1.0 (높은 마찰 = 접지력)
          캐스터: mu = 0.001 (거의 무마찰 = 자유 미끄러짐)
          
        왜?
          차동 구동의 회전 원리:
            좌우 바퀴 속도 차이 → 회전
              이때 캐스터는 옆으로 미끄러져야 함!
              캐스터 마찰이 높으면 → 회전 못 함!
      -->
      <kp>1000000.0</kp>
      <kd>100.0</kd>
      <!--
        kp: 접촉 강성 (높아야 바닥을 안 뚫음)
        kd: 접촉 감쇠 (바운스 방지)
        
        kd를 10→100으로 올림:
          캐스터가 작고 가벼워서 진동이 생기기 쉬움
          감쇠를 높여서 안정화!
      -->
    </gazebo>    \
    
  </xacro:macro>


  <!-- 캐스터 매크로 호출 — 2개 생성! -->

  <xacro:caster_wheel prefix="front_left" y_reflect="1"/>
  <xacro:caster_wheel prefix="front_right" y_reflect="-1"/>


</robot>